Oto pe≈Çny zapis poprawionej funkcji handle_task w klasie TaskManager. Zmiana polega na dodaniu obs≈Çugi nowego parametru lookup_keys i przekazaniu go do db_manager.insert_data w sekcji ≈Çadowania danych.
# --- Klasa TaskManager (plik importy.py) ---

def handle_task(self, task: dict):
    
    task_name = task.get('name', 'Nieznane Zadanie')
    start_time = datetime.now()
    
    try:
        # Zapis poczƒÖtkowy logu
        self._log_task(task_name, status='Running', start_time=start_time)
        self.logger.info(f"Rozpoczynanie zadania: {task_name}")

        # 1. Obs≈Çuga delete_temp
        if task.get('delete_temp'):
            self.logger.info("Wykonywanie czyszczenia tabel tymczasowych")
            self.db_manager.drop_oracle_tables_with_keywords('Oracle', 'TEMP') # Zak≈Çadam, ≈ºe ta metoda jest zdefiniowana

        # 2. Obs≈Çuga delete_query
        if task.get('delete_query'):
            self.logger.info("Wykonywanie zapytania usuwajƒÖcego dane")
            self.db_manager.execute_sql(task['destination_db'], task['delete_query'])

        # 3. Obs≈Çuga fetch_sql (pobieranie danych)
        df = None
        fetch_params = task.get('date_param')
        if task.get('fetch_sql'):
            self.logger.info(f"Pobieram i wstawiam dane: {task['sql_table']}")
            
            df = self.db_manager.fetch_data(
                source_db=task['source_db'],
                fetch_sql=task['fetch_sql'],
                params=fetch_params,
                split_by_semicolon=True if task.get('split_by_semicolon') is not False else False
            )

        # 4. Obs≈Çuga insert_missing (wstawianie brakujƒÖcych wierszy - stara logika)
        if task.get('insert_missing') and task.get('key_columns'):
             # ... (Twoja logika dla 'insert_missing' ‚Äì zostawiam Twoje oryginalne wywo≈Çanie)
             self.logger.info("Tryb: wstawiamy tylko brakujƒÖce wiersze po kluczach")
             self.db_manager.insert_data(...) # Twoje oryginalne wywo≈Çanie
        
        # 5. Obs≈Çuga wstawiania danych (standardowe lub z lookup)
        if 'destination_db' in task and df is not None:
            self.logger.info(f"Wstawianie danych do bazy {task['destination_db']} - tabela {task['sql_table']}")
            
            # üí• NOWO≈öƒÜ: POBRANIE KLUCZY LOOKUP
            lookup_keys = task.get('lookup_keys', None)
            
            self.db_manager.insert_data(
                df=df,
                target_db=task['destination_db'],
                table_name=task['sql_table'],
                schema=task['schema'],
                batch_size=task.get('batch_size', 1500000), 
                if_exists=task.get('if_exists', 'append'),
                # üí• PRZEKAZANIE KLUCZY LOOKUP
                lookup_keys=lookup_keys 
            )

        # 6. Obs≈Çuga execute_query
        if 'execute_query' in task:
            self.logger.info("Wykonywanie zapytania")
            self.db_manager.execute_sql(task['source_db'], task['execute_query'], task.get('date_param'))

        # 7. Obs≈Çuga procedure
        if 'procedure' in task:
            self.logger.info("Wykonywanie procedury")
            self.db_manager.execute_sql(task['source_db'], task['procedure'])

        # 8. Obs≈Çuga merge (stara logika)
        if 'merge' in task:
            self.logger.info("Wykonywanie MERGE")
            target_table = f" {task['schema']}.{task['sql_table']}"
            source_table = f" {task['schema']}.{task['merge'][0]}"
            self.db_manager.execute_merge_via_procedure(
                db_name=task['destination_db'], 
                source_table=source_table, 
                target_table=target_table, 
                key_columns=task['key_columns']) # Zak≈Çadam, ≈ºe ta metoda jest zdefiniowana
            

        end_time = datetime.now()
        self._log_task(task_name, status='SUCCESS', start_time=start_time, end_time=end_time)
        self.logger.info(f"Zadanie {task_name} zako≈Ñczone pomy≈õlnie. Czas trwania: {end_time - start_time}")
        return True
        
    except Exception as e:
        end_time = datetime.now()
        error_msg = f"B≈ÇƒÖd podczas wykonywania zadania {task_name}: {str(e)}"
        self._log_task(task_name, status='ERROR', start_time=start_time, end_time=end_time, message=error_msg)
        self.logger.error(error_msg)
        return False

