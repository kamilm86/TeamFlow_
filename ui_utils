# ui_utils.py
from PySide6.QtCore import Qt
from PySide6.QtWidgets import QPushButton, QMessageBox
from styles import AppStyles


def _apply_message_box_style(msg_box, parent):
    """Pomocnicza funkcja aplikująca styl do QMessageBox."""
    # 1. Wykrywanie motywu (szukamy atrybutu u rodzica lub zakładamy domyślny)
    is_dark = True  # Domyślny

    if parent:
        if hasattr(parent, 'is_dark_theme'):
            is_dark = parent.is_dark_theme
        elif hasattr(parent, 'parent_widget') and hasattr(parent.parent_widget, 'is_dark_theme'):
            # Czasami parent to np. QDialog, który ma parent_widget jako główne okno
            is_dark = parent.parent_widget.is_dark_theme
        elif hasattr(parent, 'parent') and hasattr(parent.parent(), 'is_dark_theme'):
            is_dark = parent.parent().is_dark_theme

    theme = "dark" if is_dark else "light"

    # 2. Pobieranie czcionki
    font_family = "Segoe UI"
    font_size = 9
    if parent and hasattr(parent, 'font'):
        font_family = parent.font().family()
        font_size = parent.font().pointSize()

    # 3. Pobieranie stylów
    dialog_style = AppStyles.get_dialog_style(theme)
    button_style = AppStyles.get_button_style(theme, font_family, font_size)

    # 4. Aplikacja stylów
    # Nadpisujemy selektor QDialog na QMessageBox, aby style zadziałały
    msg_box.setStyleSheet(dialog_style.replace("QDialog {", "QMessageBox {"))

    # Stylujemy przyciski wewnątrz
    for button in msg_box.buttons():
        button.setStyleSheet(button_style)

    return theme


def show_confirmation_dialog(parent, title: str, message: str,
                             default_button=QMessageBox.Yes) -> QMessageBox.StandardButton:
    """Wyświetla stylowane okno potwierdzenia (Tak/Nie)."""
    msg_box = QMessageBox(parent)
    msg_box.setWindowTitle(title)
    msg_box.setTextFormat(Qt.RichText)
    msg_box.setText(message)
    msg_box.setIcon(QMessageBox.Question)

    yes_button = msg_box.addButton("Tak", QMessageBox.YesRole)
    no_button = msg_box.addButton("Nie", QMessageBox.NoRole)

    _apply_message_box_style(msg_box, parent)

    if default_button == QMessageBox.Yes:
        msg_box.setDefaultButton(yes_button)
    else:
        msg_box.setDefaultButton(no_button)

    msg_box.exec()

    if msg_box.clickedButton() == yes_button:
        return QMessageBox.Yes
    return QMessageBox.No


def show_error_dialog(parent, title: str, message: str):
    """Wyświetla stylowane okno błędu (Critical)."""
    msg_box = QMessageBox(parent)
    msg_box.setWindowTitle(title)
    msg_box.setTextFormat(Qt.RichText)
    msg_box.setText(message)
    msg_box.setIcon(QMessageBox.Critical)
    msg_box.addButton("OK", QMessageBox.AcceptRole)

    _apply_message_box_style(msg_box, parent)
    msg_box.exec()


def show_warning_dialog(parent, title: str, message: str):
    """Wyświetla stylowane okno ostrzeżenia (Warning)."""
    msg_box = QMessageBox(parent)
    msg_box.setWindowTitle(title)
    msg_box.setTextFormat(Qt.RichText)
    msg_box.setText(message)
    msg_box.setIcon(QMessageBox.Warning)
    msg_box.addButton("OK", QMessageBox.AcceptRole)

    _apply_message_box_style(msg_box, parent)
    msg_box.exec()


def show_info_dialog(parent, title: str, message: str):
    """Wyświetla stylowane okno informacyjne (Information)."""
    msg_box = QMessageBox(parent)
    msg_box.setWindowTitle(title)
    msg_box.setTextFormat(Qt.RichText)
    msg_box.setText(message)
    msg_box.setIcon(QMessageBox.Information)
    msg_box.addButton("OK", QMessageBox.AcceptRole)

    _apply_message_box_style(msg_box, parent)
    msg_box.exec()
